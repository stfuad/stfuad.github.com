<html>
    <head>
        <meta charset="utf-8">
        <title>Initiative Tracker</title>
        <style>
            body {
                display: grid;
                grid-template-columns: 300px 500px 1fr;
                grid-template-rows: 24px 20px 1fr 1fr;
                grid-gap: 10px;
                font-family: 'Courier New', Courier, monospace;
                font-size: 1em;
                height: 100vh;
                margin: 0px;
            }

            #creatureList {
                grid-column: 1;
                grid-row: 1/5;
                height: calc(100vh - 2px);
                overflow: auto;
                border: 1px solid black;
                margin: 0px;
                padding: 0px;
            }
            #creatureList > .listHeader {
                height: 20px;
                background-color: lightblue;
                text-indent: 1em;
                border: 1px solid black;
            }

            #creatureList > .listItem {
                height: 20px;
                text-indent: 2em;
                border: 1px solid black;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                cursor: pointer;
            }

            #creatureList > .listItem:hover {
                background-color: aliceblue;
            }

            #toolbar {
                grid-column: 2;
                grid-row: 1;
                max-height: 24px;
                border: 1px solid black;
            }

            #trackerHeaders {
                grid-column: 2;
                grid-row: 2;
                max-height: 20px;
                border: 1px solid black;
            }

            #trackerHeaders > h4 {
                display: inline-block;
                padding-left: 10px;
                padding-right: 10px;
                margin: 0px;
            }

            .name {
                width: 200px;
            }

            .hp {
                width: 70px;
            }

            .init {
                width: 50px;
            }

            #tracker {
                grid-column: 2;
                grid-row: 3/5;
                height: calc(100vh - 66px); 
                overflow: auto;
                border: 1px solid black;
            }

            #sheet {
                grid-column: 3;
                grid-row: 1/5;
                height: calc(100vh - 22px);
                overflow: auto;
                padding: 10px;
                border: 1px solid black;
            }

        </style>
    </head>
    <body>
        <div id="creatureList"></div>
        <div id="sheet"></div>

        <div id="toolbar">
            <button type="button">Add PC</button>
            <button type="button">Clear</button>
        </div>
        <div id="trackerHeaders">
            <h4 class="name">Name</h4>
            <h4 class="hp">HP</h4>
            <h4 class="init">Initiative</h4>
        </div>
        <div id="tracker"></div>

        <script>
            /* let host = document.querySelector("#tracker");

            let buttons = document.createElement('div');
            buttons.id = "toolbar";

            let addPc = document.createElement('button');
            addPc.appendChild(document.createTextNode("Add PC"));
            addPc.addEventListener('click', () => {
                let div = document.createElement('div');
                div.className = "modal";

                let h41 = document.createElement('h4');
                h41.appendChild(document.createTextNode("Name:"));
                div.appendChild(h41);

                let input1 = document.createElement('input');

                div.appendChild(input1);

                let h42 = document.createElement('h4');
                h42.appendChild(document.createTextNode("Initiative:"));

                div.appendChild(h42);

                let input2 = document.createElement('input');
        
                div.appendChild(input2);

                let button = document.createElement('button');
                button.appendChild(document.createTextNode("Submit"));
                button.addEventListener('click', () => {
                    
                }, false)

                host.appendChild(div);
            }, false);

            buttons.appendChild(addPc);

            let sort = document.createElement('button');
            sort.appendChild(document.createTextNode("Sort"));
            sort.addEventListener('click', () => {
                let target = document.querySelectorAll("creature-listitem");

            }, false);

            buttons.appendChild(sort);

            let clear = document.createElement('button');
            clear.appendChild(document.createTextNode("Clear"));
            clear.addEventListener('click', () => {
                let target = document.querySelectorAll("creature-listitem");

                for (node of target) {
                    node.remove();
                }
            }, false);

            buttons.appendChild(clear);

            host.appendChild(buttons);

            let headers = document.createElement('div');
            
            let name = document.createElement('span');
            name.appendChild(document.createTextNode("Name"));
            name.className = "name";

            headers.appendChild(name);

            let hp = document.createElement('span');
            hp.appendChild(document.createTextNode("HP"));
            hp.className = "hp";

            headers.appendChild(hp);

            let init = document.createElement('span');
            init.appendChild(document.createTextNode("Initiative"));
            init.className = "init";

            headers.appendChild(init);

            host.appendChild(headers); */
        </script>

        <script>
            let bestiary = JSON.parse(localStorage.getItem("Bestiary"));

            import("./modules/sorting.module.js")
                .then(module => {
                    let target = document.querySelector("#creatureList");

                    let sorted = module.SortByName(bestiary);

                    for (let array in sorted) {
                        let listHeader = document.createElement('div');
                        listHeader.className = "listHeader";
                        listHeader.appendChild(document.createTextNode(array));
                        target.appendChild(listHeader);

                        sorted[array].sort().forEach(item => {
                            let listItem = document.createElement('div');
                            listItem.className = "listItem";
                            listItem.appendChild(document.createTextNode(item));
                            listItem.addEventListener('click', event => {
                                let target = document.querySelector("#tracker");

                                let creature = new CreatureListItem(item, bestiary[item], event);

                                target.appendChild(creature);
                            }, false);

                            target.appendChild(listItem);
                        });
                    }
                });

            class CreatureListItem extends HTMLElement {
                set name(val) {
                    if (val) {
                        this.setAttribute('name', '');
                    } else {
                        this.removeAttribute('name');
                    }
                }

                get name() {
                    return this.hasAttribute('name');
                }

                set hp(val) {
                    if (val) {
                        this.setAttribute('hp', '');
                    } else {
                        this.removeAttribute('hp');
                    }
                }

                get init() {
                    return this.hasAttribute('init');
                }

                set init(val) {
                    if (val) {
                        this.setAttribute('init', '');
                    } else {
                        this.removeAttribute('init');
                    }
                }

                get hp() {
                    return this.hasAttribute('hp');
                }

                static get observedAttributes() {
                    return ['init', 'hp'];
                }

                constructor(name, json, event) {
                    super();

                    let shadow = this.attachShadow({mode: 'open'});

                    let style = document.createElement('style');
                    style.textContent = `
                        :host {
                            display: grid;
                            grid-template-columns: 235px 105px 50px 1fr;
                            grid-template-rows: 1fr;
                            border: 1px solid black;
                        }

                        input {
                            border: 0px;
                        }

                        #name {
                            grid-column: 1;
                            text-indent: 1em;
                        }

                        #hp {
                            grid-column: 2;
                        }

                        #init {
                            grid-column: 3;
                        }

                        #buttons {
                            grid-column: 4;
                        }

                        #buttons > button {
                            float: right;
                        }
                    `;

                    shadow.appendChild(style);

                    this.setAttribute('name', name);

                    let creatureName = document.createElement('input');
                    creatureName.type = "text";
                    creatureName.value = name;
                    creatureName.readOnly = true;
                    creatureName.id = "name";

                    shadow.appendChild(creatureName);

                    let conMod = Math.floor((json["Ability Scores"]["Constitution"] - 10) / 2);

                    let hitDice = json["Hit Dice"]

                    let split = hitDice.split(/d/);

                    let split0 = parseInt(split[0]);
                    let split1 = parseInt(split[1]);
                    
                    let average = (split1 + 1) / 2 * split0 + conMod;
                    let max = (split0 * split1) + conMod;

                    this.setAttribute('hp', max);

                    let creatureHP = document.createElement('input');
                    creatureHP.type = "text";
                    creatureHP.value = this.getAttribute('hp');
                    creatureHP.readOnly = true;
                    creatureHP.id = "hp";

                    shadow.appendChild(creatureHP);

                    let dexMod = Math.floor((json["Ability Scores"]["Dexterity"] - 10) / 2);
                    let roll = Math.floor(Math.random() * 20) + 1;

                    this.setAttribute('init', dexMod + roll);

                    let creatureInit = document.createElement('input');
                    creatureInit.type = "text";
                    creatureInit.value = this.getAttribute('init');
                    creatureInit.readOnly = true;
                    creatureInit.id = "init";

                    shadow.appendChild(creatureInit);

                    let buttons = document.createElement('div');

                    let view = document.createElement('button');
                    view.type = "button";
                    view.appendChild(document.createTextNode("\uD83D\uDCC4"));
                    view.addEventListener('click', () => {
                        import("./classes/creatureSheet.class.js")
                            .then(module => {
                                let host = document.querySelector("#sheet");
                                let target = host.querySelector("creature-sheet");
    
                                if (target !== null) {
                                    target.remove()
                                }

                                host.appendChild(new module.CreatureSheet(name, json));
                            });
                    }, false);

                    buttons.appendChild(view);

                    let edit = document.createElement('button');
                    edit.type = "button";
                    edit.appendChild(document.createTextNode("\u270E"));
                    edit.addEventListener('click', () => {
                        let inputs = shadow.querySelectorAll('input');

                        let store1 = this.getAttribute('name');
                        for (let node of inputs) {
                            if (node.readOnly === true) {
                                node.readOnly = false;
                            } else if (node.readOnly === false) {
                                node.readOnly = true;
                            }
                        }
                    }, false);

                    buttons.appendChild(edit);

                    let close = document.createElement('button');
                    close.type = "button";
                    close.appendChild(document.createTextNode("\u2716"));
                    close.addEventListener('click', () => {
                        this.remove();
                    }, false);
                    close.className = "closeButton";

                    buttons.appendChild(close);

                    shadow.appendChild(buttons);
                } 
            }

            customElements.define('creature-listitem', CreatureListItem);

            class PCListItem extends HTMLElement {
                get init() {
                    return this.hasAttribute('init');
                }

                set init(val) {
                    if (val) {
                        this.setAttribute('init', '');
                    } else {
                        this.removeAttribute('init');
                    }
                }

                static get observedAttributes() {
                    return ['init'];
                }

                constructor(name, init) {
                    super();

                    let shadow = this.attachShadow({mode: 'open'});

                    let style = document.createElement('style');
                    style.textContent = `
                        #container {
                            border: 1px solid black;
                            padding: 10px;
                        }

                        button {
                            background-color: white;
                            border: 0px;
                        }

                        .name {
                            display: inline-block;
                            padding-left: 10px;
                            padding-right: 10px;
                            min-width: 200px;
                        }

                        .init {
                            display: inline-block;
                            padding-left: 10px;
                            padding-right: 10px;
                            width: 50px;
                        }

                        .closeButton {
                            float: right;
                            top: 4px
                        }

                    `;

                    shadow.appendChild(style);

                    let div = document.createElement('div');
                    div.id = "container";

                    let pcName = document.createElement('span');
                    pcName.appendChild(document.createTextNode(name));
                    pcName.className = "name";

                    div.appendChild(pcName);
                    
                    let pcInit = document.createElement('span');
                    pcInit.appendChild(init);
                    pcInit.className = "init";

                    div.appendChild(pcInit);
                    
                    let close = document.createElement('button');
                    close.appendChild(document.createTextNode("\u2716"));
                    close.addEventListener('click', () => {
                        this.remove();
                    }, false);
                    close.className = "closeButton";

                    div.appendChild(close);

                    shadow.appendChild(div);
                } 
            }

            customElements.define('pc-listitem', PCListItem);
        </script>
    </body>
</html>