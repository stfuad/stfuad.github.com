<html>
    <head>
        <meta charset="utf-8">
        <title>Initiative Tracker</title>
        <style>
            body {
                display: grid;
                grid-template-columns: 300px 500px 1fr;
                grid-template-rows: 24px 20px 1fr 1fr;
                grid-gap: 10px;
                font-family: 'Courier New', Courier, monospace;
                font-size: 1em;
                height: 100vh;
                margin: 0px;
            }

            #creatureList {
                grid-column: 1;
                grid-row: 1/5;
                height: calc(100vh - 2px);
                border: 1px solid black;
                margin: 0px;
                padding: 0px;
            }

            #creatureList #tabs {
                height: 22px;
                width: auto;
                border-bottom: 1px solid black;
            }

            #creatureList #tabs > button {
                background-color: white;
                font-weight: bold;
                border-radius: 5px;
            }

            #creatureList #list {
                height: calc(100% - 22px);
                overflow: auto;
            }

            .listHeader {
                height: 20px;
                background-color: lightblue;
                text-indent: 1em;
                border: 1px solid black;
                font-weight: bold;
            }

            .listItem {
                height: 20px;
                text-indent: 2em;
                color: blue;
                border: 1px solid black;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                cursor: pointer;
            }

            .listItem:hover {
                background-color: aliceblue;
            }

            #toolbar {
                grid-column: 2;
                grid-row: 1;
                max-height: 24px;
                border: 1px solid black;
            }

            #toolbar > button {
                background-color: white;
                font-weight: bold;
                border-radius: 5px;
            }

            #trackerHeaders {
                grid-column: 2;
                grid-row: 2;
                max-height: 20px;
                border: 1px solid black;
            }

            #trackerHeaders > h4 {
                display: inline-block;
                padding-left: 10px;
                padding-right: 10px;
                margin: 0px;
            }

            .name {
                width: 200px;
            }

            .hp {
                width: 70px;
            }

            .init {
                width: 50px;
            }

            #tracker {
                grid-column: 2;
                grid-row: 3/5;
                height: calc(100vh - 66px); 
                overflow: auto;
                border: 1px solid black;
            }

            #sheet {
                grid-column: 3;
                grid-row: 1/5;
                height: calc(100vh - 22px);
                overflow: auto;
                padding: 10px;
                border: 1px solid black;
            }

        </style>
    </head>
    <body>
        <div id="creatureList">
            <div id="tabs"></div>
            <div id="list"></div>
        </div>
        <div id="sheet"></div>

        <div id="toolbar"></div>

        <div id="trackerHeaders">
            <h4 class="name">Name</h4>
            <h4 class="hp">HP</h4>
            <h4 class="init">Initiative</h4>
        </div>

        <div id="tracker"></div>

        <script>
            let parent = document.getElementById("toolbar");

            let add = document.createElement('button');
            add.type = 'button';
            add.appendChild(document.createTextNode("Add PCs"));
            add.addEventListener('click', () => {
                let target = document.querySelector("#tracker");

                let pcs = []

                pcs.push(new PCListItem("AJ"));
                pcs.push(new PCListItem("Ben"));
                pcs.push(new PCListItem("Dan"));
                pcs.push(new PCListItem("Jerry"));
                pcs.push(new PCListItem("Kyle"));
                pcs.push(new PCListItem("Sean"));
                pcs.push(new PCListItem("Steve"));

                pcs.forEach(element => {
                    target.appendChild(element);
                });
                
            }, false);

            parent.appendChild(add); 

            let sort = document.createElement('button');
            sort.type = 'button';
            sort.appendChild(document.createTextNode("Sort by Initiative"));
            sort.addEventListener('click', () => {
                let host = document.getElementById("tracker");

                let array = Array.prototype.slice.call(host.childNodes, 0);

                for (let node of array) {
                    node.remove();
                }

                let sorted = array.sort( (a, b) => {
                    return parseInt(b.getAttribute('init')) - parseInt(a.getAttribute('init'));
                });

                sorted.forEach(element => {
                    host.appendChild(element);
                });
            }, false);

            parent.appendChild(sort);

            let clear = document.createElement('button');
            clear.type = 'button';
            clear.appendChild(document.createTextNode("Clear Tracker"));
            clear.addEventListener('click', () => {
                let host = document.getElementById("tracker");

                let array = Array.prototype.slice.call(host.childNodes, 0);

                for (let node of array) {
                    node.remove();
                }
            }, false);

            parent.appendChild(clear);
        </script>

        <script>
            let bestiary = JSON.parse(localStorage.getItem("Bestiary"));

            import("./modules/sorting.module.js")
                .then(module => {
                    let tabs = document.getElementById("tabs");
                    let list = document.getElementById("list");

                    let sortedByName = module.ByName(bestiary);
                    let sortedByType = module.ByType(bestiary);
                    let sortedByCR = module.ByCR(bestiary);

                    let byName = document.createElement('button');
                    byName.type = "button";
                    byName.appendChild(document.createTextNode("by Name"));
                    byName.addEventListener('click', () => {
                        list.innerHTML = "";

                        CreateList(sortedByName, list);
                    }, false);
                    
                    tabs.appendChild(byName);

                    let byType = document.createElement('button');
                    byType.type = "button";
                    byType.appendChild(document.createTextNode("by Type"));
                    byType.addEventListener('click', () => {
                        list.innerHTML = "";
                        
                        CreateList(sortedByType, list);
                    }, false);
                    
                    tabs.appendChild(byType);

                    let byCR = document.createElement('button');
                    byCR.type = "button";
                    byCR.appendChild(document.createTextNode("by CR"));
                    byCR.addEventListener('click', () => {
                        list.innerHTML = "";
                        
                        CreateList(sortedByCR, list);
                    }, false);
                    
                    tabs.appendChild(byCR);

                    CreateList(sortedByName, list);
                });

                function CreateList(obj, parent) {
                    for (let array in obj) {

                        if ( obj[array].length > 0) {
                            let listHeader = document.createElement('div');
                            listHeader.className = "listHeader";
                            listHeader.appendChild(document.createTextNode(array));
                            parent.appendChild(listHeader);
                        }
                        
                        obj[array].sort().forEach(item => {
                            let listItem = document.createElement('div');
                            listItem.className = "listItem";
                            listItem.appendChild(document.createTextNode(item));
                            listItem.addEventListener('click', () => {
                                let target = document.querySelector("#tracker");

                                let creature = new CreatureListItem(item, bestiary[item]);

                                target.appendChild(creature);
                            }, false);

                            parent.appendChild(listItem);
                        });
                    }
                }
        </script>

        <script>
            class CreatureListItem extends HTMLElement {

                // attributes

                set name(val) {
                    if (val) {
                        this.setAttribute('name', '');
                    } else {
                        this.removeAttribute('name');
                    }
                }

                get name() {
                    return this.getAttribute('name');
                }

                set hp(val) {
                    if (val) {
                        this.setAttribute('hp', '');
                    } else {
                        this.removeAttribute('hp');
                    }
                }

                get hp() {
                    return this.getAttribute('hp');
                }

                set init(val) {
                    if (val) {
                        this.setAttribute('init', '');
                    } else {
                        this.removeAttribute('init');
                    }
                }

                get init() {
                    return this.getAttribute('init');
                }

                static get observedAttributes() {
                    return ['name', 'init', 'hp'];
                }

                constructor(name, json) {
                    super();

                    this.setAttribute('name', name);

                    let conMod = Math.floor((json["Ability Scores"]["Constitution"] - 10) / 2);

                    let hitDice = json["Hit Dice"]

                    let split = hitDice.split(/d/);

                    let split0 = parseInt(split[0]);
                    let split1 = parseInt(split[1]);
                    
                    /* let average = (split1 + 1) / 2 * split0 + conMod; */
                    let max = (split0 * split1) + conMod;

                    this.setAttribute('hp', max);

                    let dexMod = Math.floor((json["Ability Scores"]["Dexterity"] - 10) / 2);
                    let roll = Math.floor(Math.random() * 20) + 1;

                    this.setAttribute('init', dexMod + roll);

                    let shadow = this.attachShadow({mode: 'open'});

                    let style = document.createElement('style');
                    style.textContent = `
                        :host {
                            display: grid;
                            grid-template-columns: 235px 105px 50px 1fr;
                            grid-template-rows: 1fr;
                            border: 1px solid black;
                        }

                        input {
                            border: 0px;
                        }

                        #name {
                            grid-column: 1;
                            text-indent: 1em;
                        }

                        #hp {
                            grid-column: 2;
                        }

                        #init {
                            grid-column: 3;
                        }

                        #buttons {
                            grid-column: 4;
                        }

                        #buttons > button {
                            background-color: white;
                            border-radius: 5px;
                            float: right;
                        }
                    `;

                    shadow.appendChild(style);

                    // inputs

                    let creatureName = document.createElement('input');
                    creatureName.type = "text";
                    creatureName.value = this.name;
                    creatureName.id = "name";
                    creatureName.addEventListener('change', () => {
                        this.setAttribute('name', creatureName.value);
                    }, false);

                    shadow.appendChild(creatureName);

                    let creatureHP = document.createElement('input');
                    creatureHP.type = "text";
                    creatureHP.value = this.hp;
                    creatureHP.id = "hp";
                    creatureHP.addEventListener('change', () => {
                        this.setAttribute('hp', creatureHP.value);
                    }, false);

                    shadow.appendChild(creatureHP);

                    let creatureInit = document.createElement('input');
                    creatureInit.type = "text";
                    creatureInit.value = this.init;
                    creatureInit.id = "init";
                    creatureInit.addEventListener('change', () => {
                        this.setAttribute('init', creatureInit.value);
                    }, false);

                    shadow.appendChild(creatureInit);

                    // buttons

                    let buttons = document.createElement('div');
                    buttons.id = "buttons";

                    let close = document.createElement('button');
                    close.type = "button";
                    close.appendChild(document.createTextNode("\u2716"));
                    close.addEventListener('click', () => {
                        this.remove();
                    }, false);
                    close.className = "closeButton";

                    buttons.appendChild(close);

                    let view = document.createElement('button');
                    view.type = "button";
                    view.appendChild(document.createTextNode("\uD83D\uDCC4"));
                    view.addEventListener('click', () => {
                        import("./classes/sheets.classes.js")
                            .then(module => {
                                let host = document.querySelector("#sheet");
                                let target = host.querySelector("creature-sheet");
    
                                if (target !== null) {
                                    target.remove();
                                }

                                host.appendChild(new module.CreatureSheet(name, json));
                            });
                    }, false);

                    buttons.appendChild(view);

                    shadow.appendChild(buttons);
                }
            }

            customElements.define('creature-listitem', CreatureListItem);

            class PCListItem extends HTMLElement {
                
                // attributes

                set name(val) {
                    if (val) {
                        this.setAttribute('name', '');
                    } else {
                        this.removeAttribute('name');
                    }
                }

                get name() {
                    return this.getAttribute('name');
                }

                set init(val) {
                    if (val) {
                        this.setAttribute('init', '');
                    } else {
                        this.removeAttribute('init');
                    }
                }

                get init() {
                    return this.getAttribute('init');
                }

                static get observedAttributes() {
                    return ['name', 'init', 'hp'];
                }

                constructor(name) {
                    super();

                    
                    this.setAttribute('name', name);
                    
                    this.setAttribute('init', 0);

                    let shadow = this.attachShadow({mode: 'open'});

                    let style = document.createElement('style');
                    style.textContent = `
                        :host {
                            display: grid;
                            grid-template-columns: 235px 105px 50px 1fr;
                            grid-template-rows: 1fr;
                            border: 1px solid black;
                        }

                        input {
                            border: 0px;
                        }

                        #name {
                            grid-column: 1/3;
                            text-indent: 1em;
                        }

                        #init {
                            grid-column: 3;
                        }

                        #buttons {
                            grid-column: 4;
                        }

                        #buttons button {
                            background-color: white;
                            border-radius: 5px;
                            text-align: right;
                            float: right;
                        }
                    `;

                    shadow.appendChild(style);

                    // inputs

                    let pcName = document.createElement('input');
                    pcName.type = "text";
                    pcName.value = this.name;
                    pcName.id = "name";
                    pcName.addEventListener('change', () => {
                        this.setAttribute('name', pcName.value);
                    }, false);

                    shadow.appendChild(pcName);

                    let pcInit = document.createElement('input');
                    pcInit.type = "text";
                    pcInit.value = this.init;
                    pcInit.id = "init";
                    pcInit.addEventListener('change', () => {
                        this.setAttribute('init', pcInit.value);
                    }, false);

                    shadow.appendChild(pcInit);

                    // buttons

                    let buttons = document.createElement('div');
                    buttons.id = "buttons";

                    let close = document.createElement('button');
                    close.type = "button";
                    close.appendChild(document.createTextNode("\u2716"));
                    close.addEventListener('click', () => {
                        this.remove();
                    }, false);
                    close.className = "closeButton";

                    buttons.appendChild(close);

                    shadow.appendChild(buttons);
                }
            }

            customElements.define('pc-listitem', PCListItem);
        </script>
    </body>
</html>